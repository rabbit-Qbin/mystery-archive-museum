# 🔄 评论系统更新指南v1.1

## 📋 更新内容

### 已解决的问题

1. ✅ **楼层编号独立化**
   - 之前：所有档案共享数据库 ID 作为楼层号
   - 现在：每个档案独立编号（档案A：1F、2F；档案B：1F、2F）

2. ✅ **支持回复任意评论**
   - 之前：只能回复主评论（楼主）
   - 现在：可以回复任意评论，包括回复的回复

3. ✅ **探员通知系统**
   - 之前：没有通知功能
   - 现在：探员档案中显示"有人回复了你"的通知，带小红点提示

4. ✅ **数据库字段扩展**
   - 新增 `floor_number`：楼层号
   - 新增 `replied_to_agent`：被回复的探员名

---

## 🚀 部署步骤

### 第一步：更新数据库

1. 登录 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目
3. 点击左侧菜单 **SQL Editor**
4. 点击 **New Query**
5. 复制 `database-update.sql` 文件的全部内容
6. 粘贴到编辑器中
7. 点击 **Run** 执行

**验证：** 执行成功后，你应该看到：
- ✅ 2 个新字段已添加
- ✅ 现有评论已分配楼层号
- ✅ 触发器已创建

### 第二步：更新前端代码

代码已经更新完成，包括：
- ✅ `website/src/services/commentService.js` - 评论服务
- ✅ `website/src/App.jsx` - 主应用组件

### 第三步：本地测试

```bash
cd website
npm run dev
```

测试清单：
- [ ] 在不同档案发表评论，楼层号是否独立（都从 1F 开始）
- [ ] 回复主评论是否正常
- [ ] 回复别人的回复是否正常
- [ ] 点击探员档案，是否显示收到的回复通知
- [ ] 通知小红点是否显示

### 第四步：部署到 Vercel

#### 方式 A：自动部署（推荐）
```bash
git add .
git commit -m "feat: 评论系统升级 - 独立楼层号、回复任意评论、通知功能"
git push origin main
```

Vercel 会自动检测并部署。

#### 方式 B：手动部署
```bash
cd website
npm run build
vercel --prod
```

---

## 🎯 新功能使用说明

### 1. 楼层编号
- 每个档案的评论从 **1F** 开始独立编号
- 新评论自动获得下一个楼层号
- 回复不占用楼层号

### 2. 回复功能
- **回复主评论**：点击主评论右上角的"回复"按钮
- **回复回复**：鼠标悬停在回复上，会出现回复按钮
- 回复时会显示"回复 [探员名]"

### 3. 通知系统
- 当有人回复你的评论时，会收到通知
- 探员档案图标会显示红色数字徽章
- 点击探员档案查看最近 5 条回复通知

---

## 🔍 技术细节

### 数据库触发器
```sql
-- 自动为新主评论分配楼层号
CREATE TRIGGER set_floor_number
  BEFORE INSERT ON comments
  FOR EACH ROW
  EXECUTE FUNCTION assign_floor_number();
```

### 通知查询
```javascript
// 获取某个探员收到的回复
getAgentNotifications(agentName)
```

---

## ⚠️ 注意事项

1. **数据库更新是安全的**
   - 使用 `ADD COLUMN IF NOT EXISTS` 避免重复执行错误
   - 不会删除任何现有数据
   - 为现有评论自动分配楼层号

2. **兼容性**
   - 现有评论会自动获得楼层号
   - 不影响已有的评论和回复

3. **性能优化**
   - 已添加索引：`comments_replied_to_agent_idx`
   - 通知查询限制为最近 10 条

---

## 🐛 故障排查

### 问题：楼层号显示为空
**解决**：检查数据库更新脚本是否执行成功

### 问题：回复功能不工作
**解决**：清除浏览器缓存，重新加载页面

### 问题：通知不显示
**解决**：确保 `replied_to_agent` 字段已正确保存

---

## 📞 需要帮助？

如果遇到问题，检查：
1. Supabase 控制台的 SQL 执行日志
2. 浏览器开发者工具的 Console
3. Vercel 部署日志

---

**更新完成！享受新功能吧！** 🎉
